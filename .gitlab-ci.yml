stages:
  #- test
  - build_base
  - build
  - clean
  - deploy
  - release

#test_backend:
#  stage: test
#  before_script:
#    - docker network create traefik
#    - docker login ${CI_REGISTRY} -u gitlab-ci-token -p ${CI_BUILD_TOKEN}
#    - docker run --rm -v $(pwd):/data vikingco/jinja2cli .env.example > .env
#  script:
#    - ./scripts/test-local.sh
#  after_script:
#    - docker-compose down -v --remove-orphans
#    - docker network rm traefik
#    - cd ..
#    - sudo rm -rf ecoteka*
#  only:
#    refs:
#      - branches
#    changes:
#      - backend/**/*
#  tags:
#    - ns01

build_frontend:
  stage: build
  script:
    - docker login ${CI_REGISTRY} -u gitlab-ci-token -p ${CI_BUILD_TOKEN}
    - docker build -t ${CI_REGISTRY_IMAGE}:frontend-0 -f ./frontend/.docker/Dockerfile ./frontend
    - docker push ${CI_REGISTRY_IMAGE}:frontend-0
  only:
    refs:
      - master
    changes:
      - frontend/**/*
  tags:
    - ns01

build_backend_base:
  stage: build_base
  script:
    - docker login ${CI_REGISTRY} -u gitlab-ci-token -p ${CI_BUILD_TOKEN}
    - docker build -t ${CI_REGISTRY_IMAGE}:backend-base -f ./backend/Dockerfile.base ./backend
    - docker push ${CI_REGISTRY_IMAGE}:backend-base
  only:
    refs:
      - master
    changes:
      - backend/Dockerfile.base
  tags:
    - ns01

build_backend:
  stage: build
  script:
    - docker login ${CI_REGISTRY} -u gitlab-ci-token -p ${CI_BUILD_TOKEN}
    - docker build -t ${CI_REGISTRY_IMAGE}:backend-0 ./backend
    - docker push ${CI_REGISTRY_IMAGE}:backend-0
  only:
    refs:
      - master
    changes:
      - backend/**/*
  tags:
    - ns01

clean:
  stage: clean
  script:
    - docker system prune -a -f
  only:
    - master
  tags:
    - ns01

deploy_dev:
  stage: deploy
  script:
    - git clone git@gitlab.com:natural-solutions/ns-ansible-infrastructure.git
    - cd ns-ansible-infrastructure
    - echo ${VAULT_PASSWORD_KEY} > password-file
    - ansible-playbook -i hosts -l ecoteka_dev --vault-password-file password-file deploy.yml
    - rm password-file
  only:
    - master
  tags:
    - ns01
  variables:
    ANSIBLE_INVENTORY_UNPARSED_FAILED: "true"

release:
  stage: release
  script:
    - export PATH=$PATH:/home/gitlab-runner/.nvm/versions/node/v14.16.0/bin
    - semantic-release
  only:
    - master
  tags:
    - ns01
