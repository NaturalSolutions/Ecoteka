variables:
  DOCKER_DRIVER: overlay2

services:
  - docker:dind

stages:
  - build
  - pages

data:
  stage: build
  image: docker
  script:
    - docker login ${CI_REGISTRY} -u gitlab-ci-token -p ${CI_BUILD_TOKEN}
    - docker build -t ${CI_REGISTRY_IMAGE}:data-latest ./data
    - docker push ${CI_REGISTRY_IMAGE}:data-latest
  only:
    - dev
  tags:
    - ns01

build:
  stage: build
  image: docker
  script:
    - docker login ${CI_REGISTRY} -u gitlab-ci-token -p ${CI_BUILD_TOKEN}
    - docker build --build-arg asset_prefix=${ETK_ASSET_PREFIX} -t ${CI_REGISTRY_IMAGE}:latest ./frontend
    - docker push ${CI_REGISTRY_IMAGE}:latest
  only:
    - master
  tags:
    - ns01

pages:
  image: ${CI_REGISTRY_IMAGE}:latest
  stage: pages
  script:
    - cp -r /usr/share/nginx/html public
  artifacts:
    paths:
      - public
  only:
    - master
