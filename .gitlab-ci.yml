stages:
  - build_base
  - build
  - clean

build_frontend:
  stage: build
  script:
    - docker login ${CI_REGISTRY} -u gitlab-ci-token -p ${CI_BUILD_TOKEN}
    - docker build -t ${CI_REGISTRY_IMAGE}:frontend-legacy -f ./frontend/.docker/Dockerfile ./frontend
    - docker push ${CI_REGISTRY_IMAGE}:frontend-legacy
  only:
    refs:
      - legacy
    changes:
      - frontend/**/*
  tags:
    - ns01

build_backend_base:
  stage: build_base
  script:
    - docker login ${CI_REGISTRY} -u gitlab-ci-token -p ${CI_BUILD_TOKEN}
    - docker build -t ${CI_REGISTRY_IMAGE}:backend-base -f ./backend/Dockerfile.base ./backend
    - docker push ${CI_REGISTRY_IMAGE}:backend-base
  only:
    refs:
      - legacy
    changes:
      - backend/Dockerfile.base
  tags:
    - ns01

build_backend:
  stage: build
  script:
    - docker login ${CI_REGISTRY} -u gitlab-ci-token -p ${CI_BUILD_TOKEN}
    - docker build -t ${CI_REGISTRY_IMAGE}:backend-legacy ./backend
    - docker push ${CI_REGISTRY_IMAGE}:backend-legacy
  only:
    refs:
      - legacy
    changes:
      - backend/**/*
  tags:
    - ns01

clean:
  stage: clean
  script:
    - docker system prune -a -f
  only:
    - legacy
  tags:
    - ns01
