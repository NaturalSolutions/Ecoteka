stages:
  - build
  - build_prod
  - pages_prod

build_fronted:
  stage: build
  image: docker
  script:
    - docker login ${CI_REGISTRY} -u gitlab-ci-token -p ${CI_BUILD_TOKEN}
    - docker build -t ${CI_REGISTRY_IMAGE}:frontend-latest ./frontend
    - docker push ${CI_REGISTRY_IMAGE}:frontend-latest
  only:
    - 11-deploy-ci-cd
  tags:
    - ns01

build_backend:
  stage: build
  image: docker
  script:
    - docker login ${CI_REGISTRY} -u gitlab-ci-token -p ${CI_BUILD_TOKEN}
    - docker build -t ${CI_REGISTRY_IMAGE}:backend-latest ./backend
    - docker push ${CI_REGISTRY_IMAGE}:backend-latest
  only:
    - 11-deploy-ci-cd
  tags:
    - ns01

build-ecoteka-web:
  stage: build_prod
  image: docker
  script:
    - docker login ${CI_REGISTRY} -u gitlab-ci-token -p ${CI_BUILD_TOKEN}
    - docker build --build-arg asset_prefix=${ETK_ASSET_PREFIX} -t ${CI_REGISTRY_IMAGE}:latest ./frontend
    - docker push ${CI_REGISTRY_IMAGE}:latest
  only:
    - master
  tags:
    - ns01

pages:
  image: ${CI_REGISTRY_IMAGE}:latest
  stage: pages_prod
  script:
    - cp -r /usr/share/nginx/html public
  artifacts:
    paths:
      - public
  only:
    - master
